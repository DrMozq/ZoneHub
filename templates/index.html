<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZoneHub RTLS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã -->
    <meta http-equiv="refresh" content="3">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, sans-serif; }
        .map-container {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 20px auto;
            max-width: 650px;
        }
        #radarCanvas {
            display: block; margin: 0 auto;
            background-color: #ffffff; border: 1px solid #eee; border-radius: 10px;
        }
        .mac-code { color: #e83e8c; font-weight: bold; }
    </style>
</head>
<body>

<div class="container py-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <h2 class="text-center mb-4">üìç –ö–∞—Ä—Ç–∞ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>

    <div class="map-container">
        <canvas id="radarCanvas" width="600" height="600"></canvas>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
    <div class="card shadow-sm mx-auto" style="max-width: 650px;">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 text-center">
                <thead class="table-dark">
                    <tr>
                        <th>MAC-–∞–¥—Ä–µ—Å</th>
                        <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                        <th>–®–ª—é–∑–æ–≤</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tag in tags %}
                    <tr class="align-middle">
                        <td><code class="mac-code">{{ tag.mac }}</code></td>
                        <td>{{ tag.coords }}</td>
                        <td><span class="badge bg-secondary">{{ tag.gateways_count }}</span></td>
                        <td>
                            {% set seconds_ago = (now - tag.dt_object).total_seconds() %}
                            {% if seconds_ago < 40 %}
                                <span class="text-success fw-bold">‚óè Online</span>
                            {% else %}
                                <span class="text-danger fw-bold">‚óè Offline</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('radarCanvas');
    const ctx = canvas.getContext('2d');

    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ: 1 –º–µ—Ç—Ä = 130 –ø–∏–∫—Å–µ–ª–µ–π
    const scale = 130;
    const offsetX = 100;   // –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ (X=0)
    const startY = canvas.height - 100; // –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É (Y=0)

    // –î–∞–Ω–Ω—ã–µ —à–ª—é–∑–æ–≤ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç settings.py)
    const gateways = [
        { name: "x0y0", x: 0.0, y: 0.0 },
        { name: "x3y0", x: 3.0, y: 0.0 },
        { name: "x0y3", x: 0.0, y: 3.0 }
    ];

    // –î–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–∫ –∏–∑ —à–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä–∞ Flask
    const tags = [
        {% for tag in tags %}
            {% if "X:" in tag.coords %}
                {
                    label: "{{ tag.mac[-5:] }}", // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–∏–º–≤–æ–ª–æ–≤ MAC
                    x: {{ tag.coords.split(',')[0].split(':')[1].replace('–º','') | float }},
                    y: {{ tag.coords.split(',')[1].split(':')[1].replace('–º','') | float }},
                    online: {{ 'true' if (now - tag.dt_object).total_seconds() < 40 else 'false' }}
                },
            {% endif %}
        {% endfor %}
    ];

    function drawMap() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. –°–µ—Ç–∫–∞ (—à–∞–≥ 1 –º–µ—Ç—Ä)
        ctx.setLineDash([4, 4]);
        ctx.strokeStyle = "#e0e0e0";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 4; i++) {
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            ctx.beginPath();
            ctx.moveTo(offsetX + i * scale, 0);
            ctx.lineTo(offsetX + i * scale, canvas.height);
            ctx.stroke();
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ (Y-–≤–≤–µ—Ä—Ö)
            ctx.beginPath();
            ctx.moveTo(0, startY - i * scale);
            ctx.lineTo(canvas.width, startY - i * scale);
            ctx.stroke();
        }
        ctx.setLineDash([]); // –û—Ç–∫–ª—é—á–∞–µ–º –ø—É–Ω–∫—Ç–∏—Ä –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤

        // 2. –†–∏—Å—É–µ–º —à–ª—é–∑—ã (–ö—Ä–∞—Å–Ω—ã–µ —Ç–æ—á–∫–∏ + –ù–∞–∑–≤–∞–Ω–∏—è)
        gateways.forEach(g => {
            const gx = offsetX + g.x * scale;
            const gy = startY - g.y * scale;

            // –¢–æ—á–∫–∞ —à–ª—é–∑–∞
            ctx.fillStyle = "#ff4d4d";
            ctx.beginPath();
            ctx.arc(gx, gy, 7, 0, Math.PI * 2);
            ctx.fill();

            // –ù–∞–∑–≤–∞–Ω–∏–µ —à–ª—é–∑–∞
            ctx.fillStyle = "#666";
            ctx.font = "bold 12px Arial";
            ctx.fillText(g.name, gx - 15, gy + 22);
        });

        // 3. –†–∏—Å—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–∫–∏ (–°–∏–Ω–∏–µ —Ç–æ—á–∫–∏ + MAC)
        tags.forEach(t => {
            if (!t.online) return;

            const tx = offsetX + t.x * scale;
            const ty = startY - t.y * scale;

            // –°–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
            ctx.shadowBlur = 15;
            ctx.shadowColor = "rgba(0, 123, 255, 0.5)";

            // –°–∏–Ω–∏–π –∫—Ä—É–≥
            ctx.beginPath();
            ctx.arc(tx, ty, 10, 0, Math.PI * 2);
            ctx.fillStyle = "#007bff";
            ctx.fill();
            ctx.strokeStyle = "#ffffff";
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.shadowBlur = 0; // –£–±–∏—Ä–∞–µ–º —Å–≤–µ—á–µ–Ω–∏–µ –¥–ª—è —Ç–µ–∫—Å—Ç–∞

            // –ü–æ–¥–ø–∏—Å—å MAC-–∞–¥—Ä–µ—Å–∞
            ctx.fillStyle = "#000";
            ctx.font = "bold 13px Arial";
            ctx.fillText("ID: " + t.label, tx + 14, ty - 14);

            // –õ–∏–Ω–∏—è-—É–∫–∞–∑–∞—Ç–µ–ª—å –æ—Ç —Ç–æ—á–∫–∏ –∫ —Ç–µ–∫—Å—Ç—É
            ctx.strokeStyle = "#007bff";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(tx, ty);
            ctx.lineTo(tx + 12, ty - 12);
            ctx.stroke();
        });
    }

    drawMap();
</script>

</body>
</html>